---
title: "Influence of menstruation on Dutch female blood donors part 2"
author: "Sofie Ekroos"
date: "5.5.2022"
output:
  html_document:
    df_print: paged
---

# Summary

This is the second part of a series of code for the project "Influence of menstruation on Dutch female blood donors". This part allows the user to run linear regression on ferritin and Hb. The code is based on the Bayesian ferritin model by Mikko Arvas (https://github.com/FRCBS/iron_measurement_comparisons/blob/master/src/ferritin_model_bayes.Rmd).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(brms)
library(bayesplot)
library(relaimpo) # relative importance analysis 
library(broom) # needed for relative importance analysis 
```

# Data loading and preparation

## Data loading 

```{r}
load("~/folder/data.rdata")
```

### Remove ordering

```{r}
regression_data <- regression_data %>% mutate_if(is.ordered, function(x){factor(x, ordered = FALSE)})
```

## Data 

Data transformations:

* Log transformed variables: 
    * Ferritin

* Age is divided by 5 to simplify coefficient interpretation
* PBAC score is divided by 50 to simplify coefficient interpretation
* Days since last donation is made into a quadratic term
* Number of days since the last donation is transformed as $log\_last\_donation = log(last\_donation)/log(2)$ to help with the interpretation of coefficients. 
    * An increase in one of the transformed variable is equivalent to a doubling of the number of days since last donation.
* Blood volume is estimated based on Nadler's equation (female version) as $blood volume = (0.3561 × height^3) + (0.03308 × weight) + 0.1833$
    
    
### All women

```{r}
regression_data_all <- regression_data %>% 
  dplyr::select(KeyID, Weight, Smoking, Hb_g_l, Menstruation, Age, Group, Ferritin, BMI, DaysSinceLastDonation, DonationFreq2Years, DonationFreq2Years2, MenarcheAge, years_since_menarche, MenstruationLast6Months, LastMenstruation_Age, CycleRegularity, DaysBetweenCycles, BleedingDays, HormonalContraception_Use, hc_OC, hc_implant_injection, hc_transdermalpatch, hc_IUD, hc_vaginal_ring, hc_other, hc_years_OC, hc_years_implant_injection, hc_years_IUD, hc_years_vaginal_ring, hc_years_transdermal, hc_years_other, hc_age_quit, menopause_symptoms, hysterectomy, oophorectomy, nb_pregnancy, date_of_last_menstruation, Age_5, Weight_10, log_ferritin, log_DaysSinceLastDonation, iron_deficiency, pbac, pbac_intensity, pbac_50, current_hc, hc_type, current_cycleregularity, current_nbdaysbleeding, current_smoking, pbac_50, blood_volume) %>%
  mutate(Age_5 = scale(Age_5, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         pbac_50 = scale(pbac_50, scale = FALSE)[,1],
         years_since_menarche = scale(years_since_menarche, scale = FALSE)[,1],  
         DonationFreq2Years = scale(DonationFreq2Years, scale = FALSE)[,1],
         log_DaysSinceLastDonation = scale(log_DaysSinceLastDonation, scale = FALSE)[,1],
         DaysBetweenCycles = scale(DaysBetweenCycles, scale = FALSE)[,1], 
         BleedingDays = scale(BleedingDays, scale = FALSE)[,1],
         nb_pregnancy = scale(nb_pregnancy, scale = FALSE)[,1],
         BMI = scale(BMI, scale = FALSE)[,1])

```

### Premenopausal women 

```{r}
regression_data_pre <- regression_data %>% 
  filter(Group == "Premenopausal") %>% 
  dplyr::select(KeyID, Weight, Smoking, Hb_g_l, Menstruation, Age, Group, Ferritin, BMI, DaysSinceLastDonation, DonationFreq2Years, DonationFreq2Years2, MenarcheAge, years_since_menarche, MenstruationLast6Months, LastMenstruation_Age, CycleRegularity, DaysBetweenCycles, BleedingDays, HormonalContraception_Use, hc_OC, hc_implant_injection, hc_transdermalpatch, hc_IUD, hc_vaginal_ring, hc_other, hc_years_OC, hc_years_implant_injection, hc_years_IUD, hc_years_vaginal_ring, hc_years_transdermal, hc_years_other, hc_age_quit, menopause_symptoms, hysterectomy, oophorectomy, nb_pregnancy, date_of_last_menstruation, Age_5, Weight_10, log_ferritin, log_DaysSinceLastDonation, iron_deficiency, pbac, pbac_intensity, pbac_50, current_hc, hc_type, current_cycleregularity, current_nbdaysbleeding, current_smoking, pbac_50, blood_volume) %>%
  mutate(Age_5 = scale(Age_5, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         pbac_50 = scale(pbac_50, scale = FALSE)[,1],
         years_since_menarche = scale(years_since_menarche, scale = FALSE)[,1], 
         DonationFreq2Years = scale(DonationFreq2Years, scale = FALSE)[,1],
         log_DaysSinceLastDonation = scale(log_DaysSinceLastDonation, scale = FALSE)[,1],
         DaysBetweenCycles = scale(DaysBetweenCycles, scale = FALSE)[,1],  
         BleedingDays = scale(BleedingDays, scale = FALSE)[,1],
         nb_pregnancy = scale(nb_pregnancy, scale = FALSE)[,1],
         BMI = scale(BMI, scale = FALSE)[,1])

```

### Postmenopausal women 

```{r}
regression_data_post <- regression_data %>% 
  filter(Group == "Postmenopausal") %>% 
  dplyr::select(KeyID, Weight, Smoking, Hb_g_l, Menstruation, Age, Group, Ferritin, BMI, DaysSinceLastDonation, DonationFreq2Years, DonationFreq2Years2, MenarcheAge, years_since_menarche, MenstruationLast6Months, LastMenstruation_Age, CycleRegularity, DaysBetweenCycles, BleedingDays, HormonalContraception_Use, hc_OC, hc_implant_injection, hc_transdermalpatch, hc_IUD, hc_vaginal_ring, hc_other, hc_years_OC, hc_years_implant_injection, hc_years_IUD, hc_years_vaginal_ring, hc_years_transdermal, hc_years_other, hc_age_quit, menopause_symptoms, hysterectomy, oophorectomy, nb_pregnancy, date_of_last_menstruation, Age_5, Weight_10, log_ferritin, log_DaysSinceLastDonation, iron_deficiency, pbac, pbac_intensity, pbac_50, current_hc, hc_type, current_cycleregularity, current_nbdaysbleeding, current_smoking, pbac_50, blood_volume) %>%
  mutate(Age_5 = scale(Age_5, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         pbac_50 = scale(pbac_50, scale = FALSE)[,1],
         years_since_menarche = scale(years_since_menarche, scale = FALSE)[,1],
         DonationFreq2Years = scale(DonationFreq2Years, scale = FALSE)[,1],
         log_DaysSinceLastDonation = scale(log_DaysSinceLastDonation, scale = FALSE)[,1],
         DaysBetweenCycles = scale(DaysBetweenCycles, scale = FALSE)[,1],  
         BleedingDays = scale(BleedingDays, scale = FALSE)[,1], 
         nb_pregnancy = scale(nb_pregnancy, scale = FALSE)[,1],
         BMI = scale(BMI, scale = FALSE)[,1])

```

# Ferritin models

## Premenopausal women

```{r}
file <- "~/folder/linear_pre"

linear_pre <- brm(log_ferritin ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +                        
                        nb_pregnancy,
                      data = regression_data_pre,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 30000
)
summary(linear_pre)
```

## Postmenopausal women

```{r}
file <- "~/folder/linear_post"

linear_post <- brm(log_ferritin ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        #pbac_50 +   postmenopaual women have a PBAC score of 0                      
                        nb_pregnancy,
                      data = regression_data_post,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 10000
)
summary(linear_post)
```

## All women

```{r}
file <- "~/folder/linear_all"

linear_all <- brm(log_ferritin ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +
                        nb_pregnancy +
                        Group + # difference in pre- and postmenopausal women
                        Group*current_smoking, # interaction term for menopausal status and smoking
                      data = regression_data_all,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 10000
)
summary(linear_all)
```


## Diagnostics 

### Trace 

```{r}
mcmc_plot(linear_pre, type = "trace")
```

```{r}
mcmc_plot(linear_post, type = "trace")
```

```{r}
mcmc_plot(linear_all, type = "trace")
```


Chains seem to get stuck for PBAC scores in postmenopausal women, this was suspected as they are all 0 for this group and as such are removed from the final version. No chains get stuck for premenopausal women or the model with all women in it.

### ACF bars 

```{r}
mcmc_plot(linear_pre, type = "acf_bar")
```

```{r}
mcmc_plot(linear_post, type = "acf_bar")
```

```{r}
mcmc_plot(linear_all, type = "acf_bar")
```


Autocorrelation drops nicely for all variables now that PBAC scores were removed for postmenopausal women. 

### Rhat

```{r}
mcmc_plot(linear_pre, type = "rhat")
```

```{r}
mcmc_plot(linear_post, type = "rhat")
```

```{r}
mcmc_plot(linear_all, type = "rhat")
```

Rhat stays under 1 now that PBAC scores were removed for postmenopausal women.


## Forest plots 

```{r}
# premenopausal
p <- mcmc_plot(linear_pre, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p
```

```{r}
# postmenopausal
p <- mcmc_plot(linear_post, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p

```

```{r}
# all women
p <- mcmc_plot(linear_all, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p
```


## Combine groups (pre- and postmenopausal women)

Rename variables

```{r}
regressor_values <- c(
    "Age_5" = "Age (5 years)",
    "blood_volume" = "Blood volume (l)",
    "current_smokingyes" = "Smoker",
    "pbac_50" = "PBAC score (per 50 points)",
    "log_DaysSinceLastDonation" = "Days since last donation (log, /log(2))",
    "DonationFreq2Years" = "Donations in the last 2 years",
    "DonationFreq2Years2" = "Donations in the last 2 years (quadratic)",
    "npregnancy" = "Number of pregnancies",
    "current_smokingyes:GroupPostmenopausal" = "Interaction: smoker x postmenopausal",
    "current_smokingyes:GroupPremenopausal" = "Interaction: smoker x premenopausal",
    "GroupPostmenopausal" = "Postmenpausal",
    "GroupPremenopausal" = "Premenopausal"
)
```

```{r}

# model for pre- and postmenopausal groups are combined

## premenopausal
intervals_pre <- mcmc_intervals_data(
  linear_pre,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Premenopausal') %>% 
  arrange(m) # how to order the variables?

## postmenopausal
intervals_post <- mcmc_intervals_data(
  linear_post,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Postmenopausal')

## combine groups
intervals_combined <- rbind(intervals_pre,intervals_post) %>% 
  filter(! (parameter == 'b_Intercept' |  parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) 
  #arrange(m)

```

```{r}

# model that already has all women in it is handled separately from earlier model

intervals_all <- mcmc_intervals_data(
  linear_all,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>%  
  arrange(m) # how to order the variables?

intervals_all <- intervals_all %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) 
  #arrange(m)
```


```{r , fig1, fig.height = 10, fig.width = 15 ,warning=FALSE}

# Forest plot for model with pre- and postmenopausal women separated 

orlower <- -1
orupper <- 1
# Truncate ORs for plotting
plotdata_prepost <- intervals_combined %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  ) %>% mutate(is.sig = ll < 0 & hh < 0 | ll > 0 & hh > 0)

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata_prepost$Group))/5 -0.1) 
p1 <- ggplot(plotdata_prepost, aes(x = m, y = regressor, color = Group)) + 
  geom_point(position = pos,
             aes(shape = is.sig), 
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 position = pos,
                 size = 1, 
                 linetype = 1
                 ) +
  scale_color_manual(values = c("#440154FF", "#FDE725FF"),
                     limits = c("Premenopausal",  "Postmenopausal")) +
  scale_fill_manual(values = c("#440154FF", "#FDE725FF"),
                    limits = c("Premenopausal",  "Postmenopausal")) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  xlab("Coefficient") +
  theme(text = element_text(size = 20)) +
  theme(axis.title.y = element_blank())
p1

```


```{r , fig2, fig.height = 5, fig.width = 13 ,warning=FALSE}
# smaller picture for publication/presentation

p1_pub <- p1 + theme(axis.title = element_text(size = 14),
      strip.text =  element_text(size = 14),
      legend.text = element_text(size = 12),
      strip.background = element_rect(fill = "white"),
      strip.background.x = element_blank(),
      axis.text.y = element_text(size = 14),
      axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
      plot.title =  element_text(size = 16),
      plot.subtitle = element_text(size = 16,
                                   hjust = 0.5))

p1_pub
```


```{r , fig3, fig.height = 10, fig.width = 15 ,warning=FALSE}

# Forest plot for model with all women in one model

orlower <- -1
orupper <- 1
# Truncate ORs for plotting
plotdata <- intervals_all %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  ) %>% mutate(is.sig = ll < 0 & hh < 0 | ll > 0 & hh > 0)

#theme_set(bayesplot::theme_default())
p2 <- ggplot(plotdata, aes(x = m, y = regressor)) + 
  geom_point(aes(shape = is.sig), 
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 size = 1, 
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  xlab("Coefficient") +
  theme(text = element_text(size = 20)) +
  theme(axis.title.y = element_blank())
p2

```

```{r , fig4, fig.height = 5, fig.width = 10 ,warning=FALSE}
# smaller picture for publication/presentation

p2_pub <- p2 + theme(axis.title = element_text(size = 14),
      strip.text =  element_text(size = 14),
      legend.text = element_text(size = 12),
      strip.background = element_rect(fill = "white"),
      strip.background.x = element_blank(),
      axis.text.y = element_text(size = 14),
      axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
      plot.title =  element_text(size = 16),
      plot.subtitle = element_text(size = 16,
                                   hjust = 0.5))

p2_pub
```


# Hemoglobin models 

## Premenopausal women

```{r}
file <- "~/folder/linear_hb_pre"

linear_hb_pre <- brm(Hb_g_l ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +                        
                        nb_pregnancy,
                      data = regression_data_pre,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 10000
)
summary(linear_hb_pre)
```

## Postmenopausal women

```{r}
file <- "~/folder/linear_hb_post"

linear_hb_post <- brm(Hb_g_l ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        #pbac_50 +   postmenopaual women have a PBAC score of 0                      
                        nb_pregnancy,
                      data = regression_data_post,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 10000
)
summary(linear_hb_post)
```

## All women

```{r}
file <- "~/folder/linear_hb_all"

linear_hb_all <- brm(Hb_g_l ~
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +
                        nb_pregnancy +
                        Group + # difference in pre- and postmenopausal women
                        Group*current_smoking,
                      data = regression_data_all,
                      #family = bernoulli(),
                      file=file,
                      cores = 4,
                      iter= 10000
)
summary(linear_hb_all)
```


## Diagnostics 

### Trace 

```{r}
mcmc_plot(linear_hb_pre, type = "trace")
```

```{r}
mcmc_plot(linear_hb_post, type = "trace")
```

```{r}
mcmc_plot(linear_hb_all, type = "trace")
```


Chains seem to get stuck for PBAC scores in postmenopausal women, this was suspected as they are all 0 for this group and as such are removed from the final version. No chains get stuck for premenopausal women or the model with all women in it.

### ACF bars 

```{r}
mcmc_plot(linear_hb_pre, type = "acf_bar")
```

```{r}
mcmc_plot(linear_hb_post, type = "acf_bar")
```

```{r}
mcmc_plot(linear_hb_all, type = "acf_bar")
```


Autocorrelation drops nicely for all variables now that PBAC scores were removed for postmenopausal women. 

### Rhat

```{r}
mcmc_plot(linear_hb_pre, type = "rhat")
```

```{r}
mcmc_plot(linear_hb_post, type = "rhat")
```

```{r}
mcmc_plot(linear_hb_all, type = "rhat")
```

Rhat stays under 1 now that PBAC scores were removed for postmenopausal women.

## Forest plots 

```{r}
# premenopausal
p <- mcmc_plot(linear_hb_pre, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p
```

```{r}
# postmenopausal
p <- mcmc_plot(linear_hb_post, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p

```

```{r}
# all women
p <- mcmc_plot(linear_hb_all, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

p
```


## Combine groups (pre- and postmenopausal women)

Rename variables (comment out the ones not needed, may need them in future versions)

```{r}
regressor_values <- c(
    "Age_5" = "Age (5 years)",
    "blood_volume" = "Blood volume (l)",
    "current_smokingyes" = "Smoker",
    "pbac_50" = "PBAC score (per 50 points)",
    "log_DaysSinceLastDonation" = "Days since last donation (log, /log(2))",
    "DonationFreq2Years" = "Donations in the last 2 years",
    "DonationFreq2Years2" = "Donations in the last 2 years (quadratic)",
    "npregnancy" = "Number of pregnancies",
    "current_smokingyes:GroupPostmenopausal" = "Interaction: smoker x postmenopausal",
    "current_smokingyes:GroupPremenopausal" = "Interaction: smoker x premenopausal",
    "GroupPostmenopausal" = "Postmenpausal",
    "GroupPremenopausal" = "Premenopausal"
)
```

```{r}

# model for pre- and postmenopausal groups are combined

## premenopausal
intervals_hb_pre <- mcmc_intervals_data(
  linear_hb_pre,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Premenopausal') %>% 
  arrange(m) # how to order the variables?

## postmenopausal
intervals_hb_post <- mcmc_intervals_data(
  linear_hb_post,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Postmenopausal')

## combine groups
intervals_hb_combined <- rbind(intervals_hb_pre,intervals_hb_post) %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lprior' | parameter == 'lp__' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) 
  #arrange(m)

```

```{r}

# model that already has all women in it is handled separately from ealrier model

intervals_hb_all <- mcmc_intervals_data(
  linear_hb_all,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>%  
  arrange(m) # how to order the variables?

# combine groups
intervals_hb_all <- intervals_hb_all %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'lprior' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) 
  #arrange(m)
```


```{r , fig5, fig.height = 10, fig.width = 15 ,warning=FALSE}

# Forest plot for model with pre- and postmenopausal women separated 

orlower <- -10 #different scale for Hb compared to ferritin, for which we used -1
orupper <- 10 #different scale for Hb compared to ferritin, for which we used 1
# Truncate ORs for plotting
plotdata_hb_prepost <- intervals_hb_combined %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  ) %>% mutate(is.sig = ll < 0 & hh < 0 | ll > 0 & hh > 0)

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata_hb_prepost$Group))/5 -0.1) 
p3 <- ggplot(plotdata_hb_prepost, aes(x = m, y = regressor, color = Group)) + 
  geom_point(position = pos,
             aes(shape = is.sig),
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 position = pos,
                 size = 1, 
                 linetype = 1
                 ) +
  scale_color_manual(values = c("#440154FF", "#FDE725FF"),
                     limits = c("Premenopausal",  "Postmenopausal")) +
  scale_fill_manual(values = c("#440154FF", "#FDE725FF"),
                    limits = c("Premenopausal",  "Postmenopausal")) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  xlab("Coefficient") +
  theme(text = element_text(size = 20)) +
  theme(axis.title.y = element_blank())
p3

```



```{r , fig6, fig.height = 5, fig.width = 13 ,warning=FALSE}
# smaller picture for publication/presentation

p3_pub <- p3 + theme(axis.title = element_text(size = 14),
      strip.text =  element_text(size = 14),
      legend.text = element_text(size = 12),
      strip.background = element_rect(fill = "white"),
      strip.background.x = element_blank(),
      axis.text.y = element_text(size = 14),
      axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
      plot.title =  element_text(size = 16),
      plot.subtitle = element_text(size = 16,
                                   hjust = 0.5))
p3_pub
```



```{r , fig7, fig.height = 10, fig.width = 15 ,warning=FALSE}

# Forest plot for model with all women in one model

orlower <- -10
orupper <- 10
# Truncate ORs for plotting
plotdata_hb_all <- intervals_hb_all %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  ) %>% mutate(is.sig = ll < 0 & hh < 0 | ll > 0 & hh > 0)

#theme_set(bayesplot::theme_default())
p4 <- ggplot(plotdata_hb_all, aes(x = m, y = regressor)) + 
  geom_point(aes(shape = is.sig),
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 size = 1, 
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  xlab("Coefficient") +
  theme(text = element_text(size = 20)) +
  theme(axis.title.y = element_blank())
p4

```



```{r , fig8, fig.height = 5, fig.width = 10 ,warning=FALSE}
# smaller picture for publication/presentation

p4_pub <- p4 + theme(axis.title = element_text(size = 14),
      strip.text =  element_text(size = 14),
      legend.text = element_text(size = 12),
      strip.background = element_rect(fill = "white"),
      strip.background.x = element_blank(),
      axis.text.y = element_text(size = 14),
      axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
      plot.title =  element_text(size = 16),
      plot.subtitle = element_text(size = 16,
                                   hjust = 0.5))

p4_pub
```



# Relative importance analysis 

## Ferritin model

```{r}
# make a linear model object (the brm objects are Bayesian models and do not work in the relaimpo package)
lm_all <- lm(log_ferritin ~  # lm, not brm! 
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +
                        nb_pregnancy +
                        Group, # difference in pre- and postmenopausal women
                      data = regression_data_all,
)

summary(lm_all)

## 

# make a beta object (used for effect direction)
betas <- tidy(lm_all) %>% 
  mutate(beta_sign = sign(estimate),
         coefficient = estimate) %>% 
  filter(term != "(Intercept)") # filter (intercept), it's not a variable we use in the model

```


```{r}
# all women
ilm <- boot.relimp(lm_all, b = 1000, type = c("pmvd", "last",  "first"), fixed = FALSE) 
```


```{r}
plotdata <- booteval.relimp(ilm, typesel = c("pmvd"), level = 0.95)
plotdata <- tibble(regressor = names(plotdata@first),
                         lmg = plotdata@pmvd,
                         lmg_inf = plotdata@pmvd.lower[1,],
                         lmg_sup = plotdata@pmvd.upper[1,])
  
plotdata <- plotdata %>% mutate(lmg = lmg * betas$beta_sign * 100,
         lmg_inf = lmg_inf * betas$beta_sign * 100,
         lmg_sup = lmg_sup * betas$beta_sign * 100)

plotdata <- plotdata %>% mutate(regressor = case_when(
  regressor == "Weight_10" ~ "Weight (per 10 kg)",
  regressor == "pbac_50" ~ "PBAC score (per 50 points)",
  regressor == "nb_pregnancy" ~ "Nb of pregnancies",
  regressor == "Group" ~ "Postmenopausal",
  regressor == "log_DaysSinceLastDonation"~"Nb of days since last blood donation (log transformed)",
  regressor == "current_smoking" ~ "Currently smoking",
  regressor == "DonationFreq2Years2"~"Blood donation frequency in the past two years (quadratic)",
  regressor == "DonationFreq2Years"~"Blood donation frequency in the past two years",
  regressor == "current_smokingyes"~"Currently smoking",
  regressor == "blood_volume"~"Blood volume",
  regressor == "GroupPostmenopausal"~"Postmenopausal",
  regressor == "Age_5"~"Age (per 5 years)",
  TRUE ~regressor))

```

```{r , fig9, fig.height = 5, fig.width = 10 ,warning=FALSE}
dodge <- position_dodge(width=0.9)
plt1 <- ggplot(aes(x=regressor, y = lmg),data = plotdata) +
  geom_col(position = dodge) +
  geom_linerange(aes( ymin=lmg, ymax = lmg_sup), position = dodge, size = 0.5, color = "black") +
  geom_linerange(aes( ymin=lmg_inf, ymax = lmg), position = dodge, size = 0.5, color = "black",linetype=1) +
  xlab("Coefficient") +
  ylab("Average percentage of variance explained") +
  theme(text = element_text(size = 15)) +
  theme(axis.title.y = element_blank()) +
  coord_flip() 
plt1
```


## Hb model

```{r}
# make a linear model object (the brm objects are Bayesian models and do not work in the relaimpo package)
lm_all_hb <- lm(Hb_g_l ~  # lm, not brm! 
                        Age_5 +
                        blood_volume +
                        current_smoking +
                        DonationFreq2Years +
                        DonationFreq2Years2 +
                        log_DaysSinceLastDonation +
                        pbac_50 +
                        nb_pregnancy +
                        Group, # difference in pre- and postmenopausal women
                      data = regression_data_all,
)

summary(lm_all_hb)

## 

# make a beta object (used for effect direction)
betas_hb <- tidy(lm_all_hb) %>% 
  mutate(beta_sign = sign(estimate),
         coefficient = estimate) %>% 
  filter(term != "(Intercept)") # filter (intercept), it's not a variable we use in the model

```


```{r}
# all women
ilm_hb <- boot.relimp(lm_all_hb, b = 1000, type = c("pmvd", "last",  "first"), fixed = FALSE) 
```


```{r}
plotdata <- booteval.relimp(ilm_hb, typesel = c("pmvd"), level = 0.95)
plotdata <- tibble(regressor = names(plotdata@first),
                         lmg = plotdata@pmvd,
                         lmg_inf = plotdata@pmvd.lower[1,],
                         lmg_sup = plotdata@pmvd.upper[1,])
  
plotdata <- plotdata %>% mutate(lmg = lmg * betas_hb$beta_sign * 100,
         lmg_inf = lmg_inf * betas_hb$beta_sign * 100,
         lmg_sup = lmg_sup * betas_hb$beta_sign * 100)

plotdata <- plotdata %>% mutate(regressor = case_when(
  regressor == "Weight_10" ~ "Weight (per 10 kg)",
  regressor == "pbac_50" ~ "PBAC score (per 50 points)",
  regressor == "nb_pregnancy" ~ "Nb of pregnancies",
  regressor == "Group" ~ "Postmenopausal",
  regressor == "log_DaysSinceLastDonation"~"Nb of days since last blood donation (log transformed)",
  regressor == "current_smoking" ~ "Currently smoking",
  regressor == "DonationFreq2Years2"~"Blood donation frequency in the past two years (quadratic)",
  regressor == "DonationFreq2Years"~"Blood donation frequency in the past two years",
  regressor == "current_smokingyes"~"Currently smoking",
  regressor == "blood_volume"~"Blood volume",
  regressor == "GroupPostmenopausal"~"Postmenopausal",
  regressor == "Age_5"~"Age (per 5 years)",
  TRUE ~regressor))

```

```{r , fig10, fig.height = 5, fig.width = 10 ,warning=FALSE}
dodge <- position_dodge(width=0.9)
plt2 <- ggplot(aes(x=regressor, y = lmg),data = plotdata) +
  geom_col(position = dodge) +
  geom_linerange(aes( ymin=lmg, ymax = lmg_sup), position = dodge, size = 0.5, color = "black") +
  geom_linerange(aes( ymin=lmg_inf, ymax = lmg), position = dodge, size = 0.5, color = "black",linetype=1) +
  xlab("Coefficient") +
  ylab("Average percentage of variance explained") +
  theme(text = element_text(size = 15)) +
  theme(axis.title.y = element_blank()) + 
  coord_flip() 
plt2
```

